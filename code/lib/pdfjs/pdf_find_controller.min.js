var PDFFindController={startedTextExtraction:!1,extractTextPromises:[],pendingFindMatches:{},active:!1,pageContents:[],pageMatches:[],selected:{pageIdx:-1,matchIdx:-1},offset:{pageIdx:null,matchIdx:null},resumePageIdx:null,state:null,dirtyMatch:!1,findTimeout:null,pdfPageSource:null,integratedFind:!1,initialize:function(b){if("undefined"===typeof PDFFindBar||null===PDFFindBar)throw"PDFFindController cannot be initialized without a PDFFindBar instance";this.pdfPageSource=b.pdfPageSource;this.integratedFind=
b.integratedFind;b=["find","findagain","findhighlightallchange","findcasesensitivitychange"];this.firstPagePromise=new Promise(function(a){this.resolveFirstPage=a}.bind(this));this.handleEvent=this.handleEvent.bind(this);for(var a=0;a<b.length;a++)window.addEventListener(b[a],this.handleEvent)},reset:function(){this.startedTextExtraction=!1;this.extractTextPromises=[];this.active=!1},calcFindMatch:function(b){var a=this.pageContents[b],c=this.state.query,d=this.state.caseSensitive,e=c.length;if(0!==
e){d||(a=a.toLowerCase(),c=c.toLowerCase());for(var d=[],f=-e;;){f=a.indexOf(c,f+e);if(-1===f)break;d.push(f)}this.pageMatches[b]=d;this.updatePage(b);this.resumePageIdx===b&&(this.resumePageIdx=null,this.nextPageMatch())}},extractText:function(){function b(c){e.pdfPageSource.pages[c].getTextContent().then(function(d){for(var d=d.items,g="",h=0;h<d.length;h++)g+=d[h].str;e.pageContents.push(g);a[c](c);c+1<e.pdfPageSource.pages.length&&b(c+1)})}if(!this.startedTextExtraction){this.startedTextExtraction=
!0;this.pageContents=[];for(var a=[],c=0,d=this.pdfPageSource.pdfDocument.numPages;c<d;c++)this.extractTextPromises.push(new Promise(function(b){a.push(b)}));var e=this;b(0)}},handleEvent:function(b){if(null===this.state||"findagain"!==b.type)this.dirtyMatch=!0;this.state=b.detail;this.updateUIState(FindStates.FIND_PENDING);this.firstPagePromise.then(function(){this.extractText();clearTimeout(this.findTimeout);"find"===b.type?this.findTimeout=setTimeout(this.nextMatch.bind(this),250):this.nextMatch()}.bind(this))},
updatePage:function(b){var a=this.pdfPageSource.pages[b];this.selected.pageIdx===b&&a.scrollIntoView();a.textLayer&&a.textLayer.updateMatches()},nextMatch:function(){var b=this.state.findPrevious,a=this.pdfPageSource.page-1,c=this.pdfPageSource.pages.length;this.active=!0;if(this.dirtyMatch){this.dirtyMatch=!1;this.selected.pageIdx=this.selected.matchIdx=-1;this.offset.pageIdx=a;this.offset.matchIdx=null;this.hadMatch=!1;this.resumePageIdx=null;this.pageMatches=[];for(var d=this,a=0;a<c;a++)this.updatePage(a),
a in this.pendingFindMatches||(this.pendingFindMatches[a]=!0,this.extractTextPromises[a].then(function(a){delete d.pendingFindMatches[a];d.calcFindMatch(a)}))}if(""===this.state.query)this.updateUIState(FindStates.FIND_FOUND);else if(!this.resumePageIdx){c=this.offset;if(null!==c.matchIdx){a=this.pageMatches[c.pageIdx].length;if(!b&&c.matchIdx+1<a||b&&0<c.matchIdx){this.hadMatch=!0;c.matchIdx=b?c.matchIdx-1:c.matchIdx+1;this.updateMatch(!0);return}this.advanceOffsetPage(b)}this.nextPageMatch()}},
matchesReady:function(b){var a=this.offset,b=b.length,c=this.state.findPrevious;if(b)return this.hadMatch=!0,a.matchIdx=c?b-1:0,this.updateMatch(!0),!0;this.advanceOffsetPage(c);return a.wrapped&&(a.matchIdx=null,!this.hadMatch)?(this.updateMatch(!1),!0):!1},nextPageMatch:function(){null!==this.resumePageIdx&&console.error("There can only be one pending page.");do{var b=this.offset.pageIdx,a=this.pageMatches[b];if(!a){this.resumePageIdx=b;break}}while(!this.matchesReady(a))},advanceOffsetPage:function(b){var a=
this.offset,c=this.extractTextPromises.length;a.pageIdx=b?a.pageIdx-1:a.pageIdx+1;a.matchIdx=null;if(a.pageIdx>=c||0>a.pageIdx)a.pageIdx=b?c-1:0,a.wrapped=!0},updateMatch:function(b){var a=FindStates.FIND_NOTFOUND,c=this.offset.wrapped;this.offset.wrapped=!1;b&&(b=this.selected.pageIdx,this.selected.pageIdx=this.offset.pageIdx,this.selected.matchIdx=this.offset.matchIdx,a=c?FindStates.FIND_WRAPPED:FindStates.FIND_FOUND,-1!==b&&b!==this.selected.pageIdx&&this.updatePage(b));this.updateUIState(a,this.state.findPrevious);
-1!==this.selected.pageIdx&&this.updatePage(this.selected.pageIdx,!0)},updateUIState:function(b,a){this.integratedFind?FirefoxCom.request("updateFindControlState",{result:b,findPrevious:a}):PDFFindBar.updateUIState(b,a)}};
