<?xml version="1.0" encoding="UTF-8" ?>
<!--
 ____        _ _    ___  ____
/ ___|  __ _| | |_ / _ \/ ___|
\___ \ / _` | | __| | | \___ \
 ___) | (_| | | |_| |_| |___) |
|____/ \__,_|_|\__|\___/|____/

SaltOS: Framework to develop Rich Internet Applications
Copyright (C) 2012 by Josep Sanz CampderrÃ³s
More information in http://www.saltos.net or info@saltos.net

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<root>
	<list>
		<title lang="true">list</title>
		<actions include="xml/common/actions.xml" replace="true"/>
		<pager include="xml/common/pager.xml"/>
		<width>100%</width>
		<fields>
			<field>
				<name>id2</name>
				<label lang="true">id</label>
				<width></width>
				<sort>true</sort>
				<order>id</order>
			</field>
			<field>
				<name>nombre</name>
				<label lang="true">nombre</label>
				<width></width>
				<sort>true</sort>
				<order>nombre2</order>
			</field>
			<field>
				<name>descripcion</name>
				<label lang="true">descripcion</label>
				<width></width>
				<sort>true</sort>
			</field>
		</fields>
		<javascript include="xml/common/jslist.xml"/>
		<quick>
			<row>
				<field>
					<type>separator</type>
					<width>100%</width>
				</field>
				<field>
					<type>label</type>
					<label lang="true">usedfilter</label>
					<show eval="true">check_filter(array("filtro"=>""))?"true":"false"</show>
					<class>nowrap</class>
					<class2>info</class2>
				</field>
				<field>
					<name>buscar</name>
					<label lang="true">buscar</label>
					<type>text</type>
					<width>240px</width>
					<value global="filtro" eval="true">stripslashes($filtro=getParam("filtro"))</value>
					<onchange>copy_value("filtro","buscar");</onchange>
					<onkeypress>if(is_enterkey(event)) { copy_value("filtro","buscar");buscar(); }</onkeypress>
					<focus>true</focus>
					<speech>true</speech>
				</field>
				<field>
					<type>button</type>
					<value lang="true">buscar</value>
					<tip lang="true">buscartip</tip>
					<onclick>buscar()</onclick>
					<icon>find</icon>
					<class>nowrap</class>
				</field>
				<field>
					<type>button</type>
					<value lang="true">limpiar</value>
					<tip lang="true">limpiartip</tip>
					<onclick>limpiar()</onclick>
					<icon>refresh</icon>
					<class>nowrap contextmenu</class>
				</field>
			</row>
		</quick>
		<form>
			<name>list</name>
			<action>xml.php</action>
			<method>get</method>
			<fields>
				<title lang="true">filter</title>
				<buttons>true</buttons>
				<row>
					<field include="xml/common/hiddenslist.xml" replace="true" />
					<field>
						<name>filtro</name>
						<label lang="true">filtro</label>
						<type>text</type>
						<width>240px</width>
						<value global="filtro" eval="true">stripslashes($filtro=getParam("filtro"))</value>
						<colspan>2</colspan>
						<onchange>copy_value("buscar","filtro");</onchange>
						<speech>true</speech>
					</field>
				</row>
			</fields>
			<fields include="xml/common/filters.xml" replace="true" />
			<fields include="xml/common/helplist.xml" replace="true" />
			<buttons include="xml/common/buttonslist.xml" />
		</form>
		<query global="page,filtro" eval="true">"
		SELECT
			/*MYSQL LPAD(id,5,0)*//*SQLITE SUBSTR('00000' || id,-5,5)*/ id2,id,
			/*MYSQL CONCAT('link:grupos(',-id,'):',nombre) *//*SQLITE 'link:grupos(' || -id || '):' || nombre */ nombre,
			nombre nombre2,
			descripcion,
			id action_id,
			/*MYSQL CONCAT(LPAD(id,5,0),' - ',nombre) *//*SQLITE SUBSTR('00000' || id,-5,5) || ' - ' || nombre */ action_title,
			CASE ".check_sql($page,"view")." WHEN 1 THEN 'true' ELSE 'false' END action_view,
			CASE ".check_sql($page,"edit")." WHEN 1 THEN 'true' ELSE 'false' END action_edit,
			CASE ".check_sql($page,"delete")." WHEN 1 THEN 'true' ELSE 'false' END action_delete
		FROM (
			SELECT
				a.*,
				e.id_usuario id_usuario,
				a.id id_grupo
			FROM tbl_grupos a
				LEFT JOIN tbl_registros e ON e.id_aplicacion='".page2id($page)."' AND e.id_registro=a.id AND e.primero='1'
		) b
		WHERE ".make_like_query("id,nombre,descripcion",$filtro)." AND ".check_sql($page,"list")</query>
		<order global="order" eval="true">$order</order>
		<limit global="limit" eval="true">$limit</limit>
		<offset global="offset" eval="true">$offset</offset>
	</list>
	<form>
		<views>
			<view>
				<title lang="true">formview</title>
				<query>
					<query include="xml/common/qpermview.xml" replace="true" />
					<default global="id" eval="true">"SELECT * FROM tbl_grupos WHERE id=".abs($id)</default>
					<permisos>
						<permisos global="id" eval="true">"
						SELECT DISTINCT /*MYSQL CONCAT(a.id,'_','-2') *//*SQLITE a.id || '_' || '-2' */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							-2 id_permiso,
							'link:permiso_details(this):".LANG_ESCAPE("showdetalles")."' permiso,
							'0' allow,
							'0' deny,
							-2 pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						UNION
						SELECT DISTINCT /*MYSQL CONCAT(a.id,'_','-1') *//*SQLITE a.id || '_' || '-1' */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							-1 id_permiso,
							'link:permiso_details(this):".LANG_ESCAPE("hidedetalles")."' permiso,
							'0' allow,
							'0' deny,
							-1 pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						UNION
						SELECT /*MYSQL CONCAT(a.id,'_',b.id) *//*SQLITE a.id || '_' || b.id */ id,
							a.id id_aplicacion,a.nombre aplicacion,
							b.id id_permiso,b.nombre permiso,
							gp.allow allow,
							gp.deny deny,
							pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						LEFT JOIN tbl_permisos b ON b.id=ap.id_permiso
						LEFT JOIN tbl_grupos_p gp ON ap.id_aplicacion=gp.id_aplicacion AND ap.id_permiso=gp.id_permiso AND gp.id_grupo=".abs($id)."
						ORDER BY aplicacion,pos"</permisos>
					</permisos>
					<control include="xml/common/qcontrol.xml"/>
					<folders include="xml/common/qfolders.xml" />
					<help include="xml/common/qhelp.xml" replace="true" />
				</query>
			</view>
			<insert>
				<title lang="true">forminsert</title>
				<query>
					<query include="xml/common/qpermcreate.xml" replace="true" />
					<default>SELECT '0' id</default>
					<permisos>
						<permisos eval="true">"
						SELECT DISTINCT /*MYSQL CONCAT(a.id,'_','-2') *//*SQLITE a.id || '_' || '-2' */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							-2 id_permiso,
							'link:permiso_details(this):".LANG_ESCAPE("showdetalles")."' permiso,
							'0' allow,
							'0' deny,
							-2 pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						UNION
						SELECT DISTINCT /*MYSQL CONCAT(a.id,'_','-1') *//*SQLITE a.id || '_' || '-1' */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							-1 id_permiso,
							'link:permiso_details(this):".LANG_ESCAPE("hidedetalles")."' permiso,
							'0' allow,
							'0' deny,
							-1 pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						UNION
						SELECT /*MYSQL CONCAT(a.id,'_',b.id) *//*SQLITE a.id || '_' || b.id */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							b.id id_permiso,
							b.nombre permiso,
							'0' allow,
							'0' deny,
							pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						LEFT JOIN tbl_permisos b ON b.id=ap.id_permiso
						ORDER BY aplicacion,pos"</permisos>
					</permisos>
					<folders include="xml/common/qfolders.xml" />
					<help include="xml/common/qhelp.xml" replace="true" />
				</query>
			</insert>
			<update>
				<title lang="true">formupdate</title>
				<query>
					<query include="xml/common/qpermupdate.xml" replace="true" />
					<default global="id" eval="true">"SELECT * FROM tbl_grupos WHERE id=".abs($id)</default>
					<permisos>
						<permisos global="id" eval="true">"
						SELECT DISTINCT /*MYSQL CONCAT(a.id,'_','-2') *//*SQLITE a.id || '_' || '-2' */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							-2 id_permiso,
							'link:permiso_details(this):".LANG_ESCAPE("showdetalles")."' permiso,
							'0' allow,
							'0' deny,
							-2 pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						UNION
						SELECT DISTINCT /*MYSQL CONCAT(a.id,'_','-1') *//*SQLITE a.id || '_' || '-1' */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							-1 id_permiso,
							'link:permiso_details(this):".LANG_ESCAPE("hidedetalles")."' permiso,
							'0' allow,
							'0' deny,
							-1 pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						UNION
						SELECT /*MYSQL CONCAT(a.id,'_',b.id) *//*SQLITE a.id || '_' || b.id */ id,
							a.id id_aplicacion,
							a.nombre aplicacion,
							b.id id_permiso,
							b.nombre permiso,
							gp.allow allow,
							gp.deny deny,
							pos
						FROM tbl_aplicaciones_p ap
						LEFT JOIN tbl_aplicaciones a ON a.id=ap.id_aplicacion
						LEFT JOIN tbl_permisos b ON b.id=ap.id_permiso
						LEFT JOIN tbl_grupos_p gp ON ap.id_aplicacion=gp.id_aplicacion AND ap.id_permiso=gp.id_permiso AND gp.id_grupo=".abs($id)."
						ORDER BY aplicacion,pos"</permisos>
					</permisos>
					<control include="xml/common/qcontrol.xml"/>
					<folders include="xml/common/qfolders.xml" />
					<help include="xml/common/qhelp.xml" replace="true" />
				</query>
			</update>
		</views>
		<name>form</name>
		<action>xml.php</action>
		<method>post</method>
		<hiddens include="xml/common/hiddensform.xml" />
		<fields>
			<default>
				<fieldset>
					<width>700px</width>
					<title lang="true">defaultdata</title>
					<quick global="id" eval="true">$id>=0?"false":"true"</quick>
					<buttons>true</buttons>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>nombre</name>
							<label lang="true">nombre</label>
							<type>text</type>
							<width>240px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<focus global="id" eval="true">$id>=0?"true":"false"</focus>
							<required>true</required>
							<speech>true</speech>
						</field>
					</row>
					<row>
						<field>
							<name>descripcion</name>
							<label lang="true">descripcion</label>
							<type>textarea</type>
							<width>600px</width>
							<height>120px</height>
							<colspan>3</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
					</row>
				</fieldset>
			</default>
			<permisos>
				<fieldset>
					<width>700px</width>
					<title lang="true">permdata</title>
					<head>
						<field>
							<type>label</type>
							<label lang="true">aplicacion</label>
							<class>thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">permiso</label>
							<class>thead</class>
						</field>
						<field>
							<type>separator</type>
							<class>thead</class>
							<colspan>100</colspan>
						</field>
					</head>
					<row>
						<class>none</class>
						<field>
							<type>hidden</type>
							<name>id_aplicacion</name>
						</field>
						<field>
							<type>hidden</type>
							<name>id_permiso</name>
						</field>
						<field>
							<type>label</type>
							<name>aplicacion</name>
							<class>tbody</class>
							<width>180px</width>
						</field>
						<field>
							<type>label</type>
							<name>permiso</name>
							<class>tbody</class>
						</field>
						<field>
							<type>checkbox</type>
							<name>allow</name>
							<label lang="true">allow</label>
							<value>1</value>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<width>1px</width>
							<width2>1px</width2>
							<class>tbody</class>
							<class2>tbody</class2>
							<onchange>check_allow_deny(this)</onchange>
						</field>
						<field>
							<type>checkbox</type>
							<name>deny</name>
							<label lang="true">deny</label>
							<value>1</value>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<width>1px</width>
							<width2>1px</width2>
							<class>tbody</class>
							<class2>tbody</class2>
							<onchange>check_allow_deny(this)</onchange>
						</field>
					</row>
				</fieldset>
			</permisos>
			<control include="xml/common/control.xml" />
			<folders include="xml/common/folders.xml" />
			<help include="xml/common/helpform.xml" />
		</fields>
		<quick include="xml/common/quickform.xml" />
		<buttons include="xml/common/buttonsform.xml" />
		<javascript include="xml/common/jsform.xml" />
	</form>
	<insert>
		<query include="xml/common/qpermcreate.xml" replace="true"/>
		<query match="default" prefix="true" global="page" preeval="true" eval="true">make_insert_query("tbl_".$page)</query>
		<query include="xml/common/qcontrolinsert.xml" replace="true"/>
		<query match="permisos" prefix="true" eval="true">((getParam("allow") || getParam("deny")) &amp;&amp; getParam("id_permiso")>0)?"INSERT INTO tbl_grupos_p(id_grupo,id_aplicacion,id_permiso,allow,deny) VALUES((SELECT MAX(id) FROM tbl_grupos),'".intval(getParam("id_aplicacion"))."','".intval(getParam("id_permiso"))."','".intval(getParam("allow"))."','".intval(getParam("deny"))."')":""</query>
		<query include="xml/common/qfoldersinsert.xml" replace="true"/>
	</insert>
	<update>
		<query include="xml/common/qpermupdate.xml" replace="true"/>
		<query match="default" prefix="true" global="page" preeval="true" eval="true">make_update_query("tbl_".$page)</query>
		<query match="default" prefix="true" global="id" eval="true">"DELETE FROM tbl_grupos_p WHERE id_grupo='".abs($id)."'"</query>
		<query match="permisos" prefix="true" global="id" eval="true">((getParam("allow") || getParam("deny")) &amp;&amp; getParam("id_permiso")>0)?"INSERT INTO tbl_grupos_p(id_grupo,id_aplicacion,id_permiso,allow,deny) VALUES('".abs($id)."','".intval(getParam("id_aplicacion"))."','".intval(getParam("id_permiso"))."','".intval(getParam("allow"))."','".intval(getParam("deny"))."')":""</query>
        <query include="xml/common/qcontrolupdate.xml" replace="true"/>
		<query include="xml/common/qfoldersupdate.xml" replace="true"/>
	</update>
	<delete>
		<query include="xml/common/qpermdelete.xml" replace="true"/>
		<query include="xml/common/qdelete.xml" replace="true" />
		<query global="id" eval="true">"DELETE FROM tbl_grupos_p WHERE id_grupo='".intval($id)."'"</query>
		<query include="xml/common/qcontroldelete.xml" replace="true"/>
		<query include="xml/common/qfoldersdelete.xml" replace="true"/>
	</delete>
</root>
